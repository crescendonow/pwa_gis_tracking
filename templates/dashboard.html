<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA GIS Online Tracking - ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="/pwa_gis_tracking/static/css/style.css">
    <style>
        /* Branch marker tooltip styling */
        .branch-tooltip {
            background: rgba(255,255,255,0.97) !important;
            border: 1px solid #ddd !important;
            border-radius: 8px !important;
            padding: 0 !important;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15) !important;
            font-family: 'IBM Plex Sans Thai', sans-serif !important;
        }
        .branch-tooltip .leaflet-tooltip-content { padding: 8px 12px; }
        .branch-tooltip::before { border-top-color: #ddd !important; }
        /* Pagination controls */
        #fullTablePagination {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            border-top: 1px solid var(--border);
        }
        #fullTablePagination button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
    </style>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üó∫Ô∏è</text></svg>">
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display:none;">
        <div class="spinner"></div>
        <div class="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
        <div class="loading-progress" id="loadingProgress"></div>
    </div>

    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="max-w-screen-2xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="nav-brand">
                <div class="logo-icon">GIS</div>
                <div>
                    <h1>PWA GIS Online Tracking</h1>
                    <span>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• GIS ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</span>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <a href="/pwa_gis_tracking/" class="nav-link active">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
                    ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
                </a>
                <a href="/pwa_gis_tracking/detail" class="nav-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                    ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                </a>
                <a href="/pwa_gis_tracking/logout" class="nav-link" style="color:var(--text-muted);">
                    <i class="fa-solid fa-right-from-bracket"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-screen-2xl mx-auto px-4 py-6 relative z-10">
        
        <!-- Filter Bar -->
        <div class="filter-panel mb-6 fade-in">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex flex-wrap items-center gap-4">
                    <div class="filter-group">
                        <label class="filter-label">‡πÄ‡∏Ç‡∏ï</label>
                        <select id="filterZone" onchange="onFilterChange()">
                            <option value="">‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">‡∏õ‡∏µ</label>
                        <select id="filterYear" onchange="onYearChange()">
                            <option value="">‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
                        <input type="text" id="filterStartDate" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà" readonly>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                        <input type="text" id="filterEndDate" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà" readonly>
                    </div>
                    <button class="btn btn-primary" onclick="loadDashboard()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                        ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                    </button>
                    <button class="btn btn-outline" onclick="resetFilters()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                        ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
                    </button>
                </div>
                <div class="flex items-center gap-2">
                    <button class="btn btn-gold" onclick="exportExcel()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        Export Excel
                    </button>
                </div>
            </div>
        </div>

        <!-- Summary Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 mb-6" id="statsCards">
            <!-- Filled by JS -->
        </div>

        <!-- Dashboard Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- Left: Zone Sidebar -->
            <div class="lg:col-span-3">
                <div class="card">
                    <div class="card-header">
                        <h3>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                            ‡∏†‡∏π‡∏°‡∏¥‡∏†‡∏≤‡∏Ñ / ‡πÄ‡∏Ç‡∏ï
                        </h3>
                        <span class="badge badge-gold" id="totalZones">0 ‡πÄ‡∏Ç‡∏ï</span>
                    </div>
                    <div class="card-body p-0">
                        <ul class="zone-list" id="zoneList">
                            <!-- Filled by JS -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Center: Charts -->
            <div class="lg:col-span-5">
                <div class="grid grid-cols-1 gap-6">
                    <!-- Map: Thailand Zone -->
                    <div class="card">
                        <div class="card-header">
                            <h3>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                                ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡∏Å‡∏õ‡∏†. ‡∏™‡∏≤‡∏Ç‡∏≤
                            </h3>
                        </div>
                        <div class="card-body" style="padding:0;">
                            <div id="zoneMap" style="height:400px;border-radius:0 0 12px 12px;"></div>
                        </div>
                    </div>

                    <!-- Pie Chart: By Layer -->
                    <div class="card">
                        <div class="card-header">
                            <h3>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/><path d="M3 12A9 3 0 0 0 21 12"/></svg>
                                ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="max-width:350px;">
                                <canvas id="layerChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Zone Details / Branch List -->
            <div class="lg:col-span-4">
                <div class="card">
                    <div class="card-header">
                        <h3>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            <span id="detailTitle">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                        </h3>
                        <span class="badge badge-blue" id="branchCountBadge">0 ‡∏™‡∏≤‡∏Ç‡∏≤</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-wrapper" style="max-height:560px;">
                            <table class="data-table" id="branchTable">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>‡∏£‡∏´‡∏±‡∏™</th>
                                        <th>‡∏™‡∏≤‡∏Ç‡∏≤</th>
                                        <th class="text-right">‡∏£‡∏ß‡∏°</th>
                                    </tr>
                                </thead>
                                <tbody id="branchTableBody">
                                    <!-- Filled by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom: Full Table -->
        <div class="card mt-6">
            <div class="card-header">
                <h3>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/></svg>
                    ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏Ç‡∏≤
                </h3>
                <div class="flex items-center gap-2">
                    <input type="text" id="tableSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤..." class="text-sm" style="min-width:200px;" oninput="filterTable()">
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-wrapper">
                    <table class="data-table" id="fullTable">
                        <thead>
                            <tr id="fullTableHeader">
                                <!-- Filled by JS -->
                            </tr>
                        </thead>
                        <tbody id="fullTableBody">
                            <!-- Filled by JS -->
                        </tbody>
                        <tfoot id="fullTableFooter">
                            <!-- Filled by JS -->
                        </tfoot>
                    </table>
                </div>
                <div id="fullTablePagination"></div>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="max-w-screen-2xl mx-auto px-4 py-6 text-center relative z-10">
        <p class="text-xs" style="color: var(--text-muted);">
            PWA GIS Online Tracking Dashboard ¬© 2026 ‚Äî Provincial Waterworks Authority
        </p>
    </footer>

    <!-- Flatpickr -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/th.js"></script>
    <!-- Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="/pwa_gis_tracking/static/js/thai_custom_date.js"></script>
    <script src="/pwa_gis_tracking/static/js/dashboard.js"></script>
</body>
</html>