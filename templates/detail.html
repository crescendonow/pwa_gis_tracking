<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PWA GIS Online Tracking - รายละเอียด</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <link
      href="https://unpkg.com/maplibre-gl@4.5.0/dist/maplibre-gl.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/maplibre-gl@4.5.0/dist/maplibre-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link rel="stylesheet" href="/pwa_gis_tracking/static/css/style.css" />
    <link rel="stylesheet" href="/pwa_gis_tracking/static/css/responsive.css" />
    <style>
      #detailMapContainer {
        display: none;
      }
      #detailMap {
        width: 100%;
        height: 550px;
        border-radius: 0 0 8px 8px;
      }
      /* Map popup */
      .maplibregl-popup-content {
        background: #1c2538;
        color: #f1f5f9;
        border: 1px solid rgba(148, 163, 184, 0.15);
        border-radius: 10px;
        padding: 0;
        max-width: 380px;
        max-height: 420px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      }
      .maplibregl-popup-close-button {
        color: #94a3b8;
        font-size: 18px;
        padding: 4px 8px;
      }
      .maplibregl-popup-close-button:hover {
        color: #fff;
      }
      .maplibregl-popup-tip {
        border-top-color: #1c2538;
      }
      .popup-header {
        padding: 10px 14px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        font-weight: 600;
        font-size: 13px;
        color: #d4a843;
      }
      .popup-body {
        padding: 8px 14px;
        max-height: 300px;
        overflow-y: auto;
        font-size: 12px;
      }
      .popup-body table {
        width: 100%;
        border-collapse: collapse;
      }
      .popup-body td {
        padding: 3px 0;
        border-bottom: 1px solid rgba(148, 163, 184, 0.05);
        vertical-align: top;
      }
      .popup-body td:first-child {
        color: #94a3b8;
        font-weight: 500;
        padding-right: 10px;
        white-space: nowrap;
        width: 40%;
      }
      .popup-body td:last-child {
        color: #f1f5f9;
        word-break: break-all;
      }

      /* Permission banner */
      .perm-banner {
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
      }
      .perm-banner.perm-all {
        background: rgba(212, 168, 67, 0.15);
        border: 1px solid rgba(212, 168, 67, 0.3);
        color: #d4a843;
      }
      .perm-banner.perm-reg {
        background: rgba(52, 152, 219, 0.15);
        border: 1px solid rgba(52, 152, 219, 0.3);
        color: #3498db;
      }
      .perm-banner.perm-branch {
        background: rgba(46, 204, 113, 0.15);
        border: 1px solid rgba(46, 204, 113, 0.3);
        color: #2ecc71;
      }

      /* Dual list for drag-drop */
      .dual-list {
        display: flex;
        gap: 12px;
      }
      .dual-list-panel {
        flex: 1;
        background: var(--surface-2);
        border: 1px solid var(--border);
        border-radius: 8px;
        overflow: hidden;
      }
      .dual-list-header {
        padding: 8px 12px;
        font-size: 12px;
        font-weight: 600;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .dual-list-header span {
        color: var(--text-secondary);
      }
      .dual-list-header .count {
        color: var(--text-muted);
        font-weight: normal;
      }
      .dual-list-body {
        max-height: 240px;
        overflow-y: auto;
        padding: 4px;
        min-height: 80px;
      }
      .dual-list-item {
        padding: 6px 10px;
        font-size: 12px;
        color: var(--text-primary);
        border-radius: 4px;
        cursor: grab;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: background 0.15s;
      }
      .dual-list-item:hover {
        background: rgba(148, 163, 184, 0.1);
      }
      .dual-list-item .grip {
        color: var(--text-muted);
        font-size: 10px;
      }
      .dual-list-item .code {
        color: var(--pwa-gold);
        font-weight: 500;
        min-width: 60px;
      }
      .dual-list-search {
        width: 100%;
        padding: 6px 10px;
        font-size: 12px;
        border: none;
        border-bottom: 1px solid var(--border);
        background: transparent;
        color: var(--text-primary);
        outline: none;
      }
      .sortable-ghost {
        opacity: 0.4;
        background: rgba(212, 168, 67, 0.2) !important;
      }
      .sortable-chosen {
        background: rgba(52, 152, 219, 0.15) !important;
      }

      /* Layer checkbox grid */
      .layer-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 6px;
      }
      .layer-chip {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        border: 1px solid var(--border);
        background: var(--surface-2);
        transition: all 0.15s;
        user-select: none;
      }
      .layer-chip:hover {
        border-color: var(--text-muted);
      }
      .layer-chip.selected {
        border-color: var(--pwa-gold);
        background: rgba(212, 168, 67, 0.1);
      }
      .layer-chip .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        flex-shrink: 0;
      }
      .layer-chip input[type="checkbox"] {
        display: none;
      }

      /* Map controls panel */
      .map-controls {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .map-ctrl-btn {
        background: var(--surface-1);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 6px 10px;
        font-size: 11px;
        color: var(--text-secondary);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
        white-space: nowrap;
        transition: all 0.15s;
      }
      .map-ctrl-btn:hover {
        background: var(--surface-2);
        color: var(--text-primary);
      }
      .map-ctrl-btn.active {
        border-color: var(--pwa-gold);
        color: var(--pwa-gold);
      }
      .map-layer-panel {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 10;
        background: rgba(28, 37, 56, 0.95);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 8px;
        max-height: 400px;
        overflow-y: auto;
        min-width: 180px;
      }
      .map-layer-toggle {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px 6px;
        font-size: 11px;
        color: var(--text-secondary);
        cursor: pointer;
        border-radius: 4px;
      }
      .map-layer-toggle:hover {
        background: rgba(148, 163, 184, 0.1);
      }
      .map-layer-toggle input {
        accent-color: var(--pwa-gold);
      }
      .map-layer-toggle .ldot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        flex-shrink: 0;
      }

      /* Basemap toggle */
      .basemap-toggle {
        position: absolute;
        bottom: 30px;
        right: 10px;
        z-index: 10;
      }
      .basemap-btn {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        border: 2px solid rgba(255, 255, 255, 0.5);
        cursor: pointer;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }
      .basemap-btn img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .basemap-label {
        font-size: 9px;
        text-align: center;
        color: white;
        margin-top: 2px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
      }

      /* Export layer drag list */
      .export-layer-list {
        min-height: 40px;
        padding: 4px;
      }
      .export-layer-item {
        padding: 4px 8px;
        font-size: 12px;
        background: var(--surface-2);
        border: 1px solid var(--border);
        border-radius: 4px;
        margin-bottom: 3px;
        cursor: grab;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .export-layer-item .grip {
        color: var(--text-muted);
      }

      .map-footer {
        padding: 8px 20px;
        font-size: 12px;
        color: #64748b;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
    </style>
  </head>
  <body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none">
      <div class="spinner"></div>
      <div class="loading-text" id="loadingText">กำลังโหลดข้อมูล...</div>
      <div class="loading-progress" id="loadingProgress"></div>
    </div>

    <!-- Top Navigation -->
    <nav class="top-nav">
      <div
        class="max-w-screen-2xl mx-auto px-4 py-3 flex items-center justify-between"
      >
        <div class="nav-brand">
          <div class="logo-icon">GIS</div>
          <div>
            <h1>PWA GIS Online Tracking</h1>
            <span>ระบบติดตามข้อมูล GIS ออนไลน์</span>
          </div>
        </div>
        <button
          class="mobile-menu-btn"
          onclick="toggleMobileMenu()"
          aria-label="เมนู"
        >
          <i class="fa-solid fa-bars" id="menuIcon"></i>
        </button>
        <div class="flex items-center gap-2" id="navLinks">
          <a href="/pwa_gis_tracking/" class="nav-link"
            ><i class="fa-solid fa-grip"></i> ภาพรวม</a
          >
          <a href="/pwa_gis_tracking/detail" class="nav-link active"
            ><i class="fa-solid fa-file-lines"></i> รายละเอียด</a
          >
          <span
            id="navUserName"
            class="text-xs"
            style="color: var(--text-muted)"
          ></span>
          <a href="/pwa_gis_tracking/logout" class="nav-link" title="ออกจากระบบ"
            ><i class="fa-solid fa-right-from-bracket"></i
          ></a>
        </div>
      </div>
    </nav>

    <main class="max-w-screen-2xl mx-auto px-4 py-6 relative z-10">
      <!-- ═══════════════════════════════════════════════ -->
      <!-- STEP 1: Selection Panel                        -->
      <!-- ═══════════════════════════════════════════════ -->
      <div class="card mb-6 fade-in">
        <div class="card-header">
          <h3><i class="fa-solid fa-sliders"></i> เลือกข้อมูล</h3>
          <span
            id="permBadge"
            class="badge badge-gold"
            style="font-size: 11px"
          ></span>
        </div>
        <div class="card-body">
          <!-- Permission banner -->
          <div id="permBanner"></div>

          <!-- Date filters (always shown) -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
            <div>
              <label class="filter-label mb-1 block">วันที่เริ่ม</label>
              <input
                type="text"
                id="detailStartDate"
                class="w-full"
                placeholder="เลือกวันที่"
                readonly
              />
            </div>
            <div>
              <label class="filter-label mb-1 block">วันที่สิ้นสุด</label>
              <input
                type="text"
                id="detailEndDate"
                class="w-full"
                placeholder="เลือกวันที่"
                readonly
              />
            </div>
            <div class="flex items-end gap-2 md:col-span-2">
              <button class="btn btn-primary flex-1" onclick="executeQuery()">
                <i class="fa-solid fa-magnifying-glass"></i> ค้นหา
              </button>
              <button
                class="btn"
                onclick="resetSelection()"
                style="
                  background: var(--surface-2);
                  border: 1px solid var(--border);
                  color: var(--text-secondary);
                "
              >
                <i class="fa-solid fa-rotate-left"></i>
              </button>
            </div>
          </div>

          <!-- Branch selection (permission-aware) -->
          <div id="branchSelectionPanel" class="mb-4">
            <!-- Rendered by JS based on permission level -->
          </div>

          <!-- Layer selection -->
          <div class="mb-2">
            <div class="flex items-center justify-between mb-2">
              <label class="filter-label"
                ><i class="fa-solid fa-layer-group"></i> ชั้นข้อมูล</label
              >
              <div class="flex gap-2">
                <button
                  class="text-xs px-2 py-1 rounded"
                  style="
                    color: var(--pwa-gold);
                    background: rgba(212, 168, 67, 0.1);
                  "
                  onclick="selectAllLayers()"
                >
                  เลือกทั้งหมด
                </button>
                <button
                  class="text-xs px-2 py-1 rounded"
                  style="color: var(--text-muted); background: var(--surface-2)"
                  onclick="deselectAllLayers()"
                >
                  ยกเลิกทั้งหมด
                </button>
              </div>
            </div>
            <div id="layerGrid" class="layer-grid">
              <!-- Rendered by JS -->
            </div>
          </div>
        </div>
      </div>

      <!-- ═══════════════════════════════════════════════ -->
      <!-- RESULTS                                        -->
      <!-- ═══════════════════════════════════════════════ -->
      <div id="resultsSection" style="display: none">
        <!-- Stats cards -->
        <div
          class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6"
          id="detailStats"
        ></div>

        <!-- Map Section -->
        <div id="detailMapContainer" class="card mb-6">
          <div class="card-header">
            <h3>
              <i class="fa-solid fa-map-location-dot"></i>
              <span id="mapTitle">แผนที่ข้อมูล</span>
            </h3>
            <span
              id="mapFeatureCount"
              class="badge badge-gold"
              style="font-size: 12px"
              >0 features</span
            >
          </div>
          <div style="position: relative">
            <!-- Map layer toggle panel -->
            <div
              id="mapLayerPanel"
              class="map-layer-panel"
              style="display: none"
            ></div>
            <!-- Map controls (right side) -->
            <div class="map-controls">
              <button
                class="map-ctrl-btn"
                id="btnToggleLayerPanel"
                onclick="toggleLayerPanel()"
              >
                <i class="fa-solid fa-layer-group"></i> ชั้นข้อมูล
              </button>
            </div>
            <!-- Basemap toggle (bottom-right) -->
            <div class="basemap-toggle">
              <div
                class="basemap-btn"
                onclick="toggleBasemap()"
                id="basemapThumb"
                title="เปลี่ยน basemap"
              >
                <img
                  src="https://mt1.google.com/vt/lyrs=s&x=0&y=0&z=0"
                  alt="satellite"
                />
              </div>
              <div class="basemap-label" id="basemapLabel">Satellite</div>
            </div>
            <div id="detailMap"></div>
          </div>
          <div class="map-footer">
            <div
              id="mapLegend"
              style="display: flex; flex-wrap: wrap; gap: 4px"
            ></div>
            <span>คลิกที่ feature เพื่อดู properties</span>
          </div>
        </div>

        <!-- Chart + Table -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-6">
          <div class="lg:col-span-4">
            <div class="card">
              <div class="card-header">
                <h3><i class="fa-solid fa-chart-pie"></i> สัดส่วนข้อมูล</h3>
              </div>
              <div class="card-body">
                <div class="chart-container" style="max-width: 300px">
                  <canvas id="detailPieChart"></canvas>
                </div>
              </div>
            </div>
          </div>
          <div class="lg:col-span-8">
            <div class="card">
              <div class="card-header">
                <h3>
                  <i class="fa-solid fa-database"></i>
                  จำนวนข้อมูลแยกตามชั้นข้อมูล
                </h3>
              </div>
              <div class="card-body p-0">
                <table class="data-table" id="layerCountTable">
                  <thead>
                    <tr>
                      <th>ชั้นข้อมูล</th>
                      <th>ชื่อภาษาไทย</th>
                      <th class="text-right">จำนวน</th>
                      <th class="text-right">สัดส่วน %</th>
                    </tr>
                  </thead>
                  <tbody id="layerCountBody"></tbody>
                  <tfoot>
                    <tr class="total-row">
                      <td colspan="2"><strong>รวมทั้งหมด</strong></td>
                      <td class="num" id="layerTotal">0</td>
                      <td class="num">100%</td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Export Section -->
        <div class="card">
          <div class="card-header">
            <h3><i class="fa-solid fa-download"></i> Export ข้อมูล</h3>
          </div>
          <div class="card-body">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Excel export -->
              <div
                class="p-4 rounded-lg"
                style="
                  background: var(--surface-2);
                  border: 1px solid var(--border);
                "
              >
                <h4
                  class="text-sm font-semibold mb-3 flex items-center gap-2"
                  style="color: var(--pwa-gold)"
                >
                  <i class="fa-solid fa-file-excel"></i> Export ตารางสรุป
                  (.xlsx)
                </h4>
                <p class="text-xs mb-4" style="color: var(--text-muted)">
                  ส่งออกตารางสรุปจำนวนข้อมูลของสาขาที่เลือก
                </p>
                <button class="btn btn-gold" onclick="exportDetailExcel()">
                  <i class="fa-solid fa-download"></i> Download Excel
                </button>
              </div>
              <!-- GeoData export -->
              <div
                class="p-4 rounded-lg"
                style="
                  background: var(--surface-2);
                  border: 1px solid var(--border);
                "
              >
                <h4
                  class="text-sm font-semibold mb-3 flex items-center gap-2"
                  style="color: var(--accent-cyan)"
                >
                  <i class="fa-solid fa-earth-asia"></i> Export
                  ข้อมูลเชิงพื้นที่
                </h4>
                <p class="text-xs mb-2" style="color: var(--text-muted)">
                  ลาก Layer ที่ต้องการ export (หรือ export ทั้งหมด)
                </p>
                <!-- Export layer drag list -->
                <div class="mb-3">
                  <div class="flex items-center justify-between mb-1">
                    <span class="text-xs" style="color: var(--text-muted)"
                      >Layer ที่จะ export:</span
                    >
                    <button
                      class="text-xs px-2 py-1 rounded"
                      style="
                        color: var(--pwa-gold);
                        background: rgba(212, 168, 67, 0.1);
                      "
                      onclick="addAllExportLayers()"
                    >
                      เพิ่มทั้งหมด
                    </button>
                  </div>
                  <div
                    id="exportLayerList"
                    class="export-layer-list"
                    style="
                      border: 1px dashed var(--border);
                      border-radius: 6px;
                      min-height: 40px;
                      padding: 4px;
                    "
                  >
                    <!-- Drag layers here -->
                  </div>
                </div>
                <div class="flex items-center gap-3 mb-4">
                  <label class="filter-label">รูปแบบ</label>
                  <select id="exportFormat" class="flex-1">
                    <option value="geojson">GeoJSON (.geojson)</option>
                    <option value="gpkg">GeoPackage (.gpkg)</option>
                    <option value="shp">Shape File (.shp)</option>
                    <option value="fgb">FlatGeobuf (.fgb)</option>
                    <option value="tab">MapInfo TAB (.tab)</option>
                    <option value="pmtiles">PMTiles (.pmtiles)</option>
                  </select>
                </div>
                <button class="btn btn-primary" onclick="exportGeoData()">
                  <i class="fa-solid fa-download"></i> Download GeoData
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div id="emptyState" class="text-center py-20">
        <div
          class="inline-flex items-center justify-center w-20 h-20 rounded-2xl mb-6"
          style="background: var(--surface-2)"
        >
          <i
            class="fa-solid fa-map-location-dot fa-3x"
            style="color: var(--text-muted)"
          ></i>
        </div>
        <h3
          class="text-lg font-semibold mb-2"
          style="color: var(--text-secondary)"
        >
          เลือกสาขาเพื่อดูข้อมูล
        </h3>
        <p class="text-sm" style="color: var(--text-muted)">
          กรุณาเลือกสาขาและชั้นข้อมูล จากนั้นกดปุ่ม "ค้นหา"
        </p>
      </div>
    </main>

    <footer
      class="max-w-screen-2xl mx-auto px-4 py-6 text-center relative z-10"
    >
      <p class="text-xs" style="color: var(--text-muted)">
        PWA GIS Online Tracking Dashboard © 2025 — Provincial Waterworks
        Authority
      </p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/th.js"></script>
    <script src="/pwa_gis_tracking/static/js/thai_custom_date.js"></script>
    <script src="/pwa_gis_tracking/static/js/layer_modal.js"></script>
    <script src="/pwa_gis_tracking/static/js/detail.js"></script>

    <script>
      function toggleMobileMenu() {
        var nav = document.getElementById("navLinks");
        var icon = document.getElementById("menuIcon");
        nav.classList.toggle("active");
        icon.className = nav.classList.contains("active")
          ? "fa-solid fa-xmark"
          : "fa-solid fa-bars";
      }
    </script>
  </body>
</html>
