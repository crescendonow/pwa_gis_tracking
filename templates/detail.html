<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA GIS Online Tracking - ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üó∫Ô∏è</text></svg>">
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display:none;">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
        <div class="loading-progress" id="loadingProgress"></div>
    </div>

    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="max-w-screen-2xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="nav-brand">
                <div class="logo-icon">GIS</div>
                <div>
                    <h1>PWA GIS Online Tracking</h1>
                    <span>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• GIS ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</span>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <a href="/" class="nav-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
                    ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
                </a>
                <a href="/detail" class="nav-link active">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                    ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-screen-2xl mx-auto px-4 py-6 relative z-10">

        <!-- Step 1: Select Branch & Layer -->
        <div class="card mb-6 fade-in">
            <div class="card-header">
                <h3>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                    ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏•‡∏∞‡∏ä‡∏±‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </h3>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
                    <!-- Zone -->
                    <div>
                        <label class="filter-label mb-1 block">‡πÄ‡∏Ç‡∏ï</label>
                        <select id="detailZone" onchange="onDetailZoneChange()" class="w-full">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï</option>
                        </select>
                    </div>
                    <!-- Branch -->
                    <div>
                        <label class="filter-label mb-1 block">‡∏™‡∏≤‡∏Ç‡∏≤</label>
                        <select id="detailBranch" class="w-full">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>
                        </select>
                    </div>
                    <!-- Layer -->
                    <div>
                        <label class="filter-label mb-1 block">‡∏ä‡∏±‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label>
                        <select id="detailLayer" class="w-full">
                            <option value="">‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</option>
                        </select>
                    </div>
                    <!-- Date From -->
                    <div>
                        <label class="filter-label mb-1 block">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
                        <input type="text" id="detailStartDate" class="w-full" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà" readonly>
                    </div>
                    <!-- Date To -->
                    <div>
                        <label class="filter-label mb-1 block">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                        <input type="text" id="detailEndDate" class="w-full" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà" readonly>
                    </div>
                    <!-- Actions -->
                    <div class="flex items-end gap-2">
                        <button class="btn btn-primary flex-1" onclick="loadBranchDetail()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                            ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" style="display:none;">

            <!-- Branch Summary Stats -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6" id="detailStats">
                <!-- Filled by JS -->
            </div>

            <!-- Branch Layer Chart + Table -->
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-6">
                <!-- Chart -->
                <div class="lg:col-span-4">
                    <div class="card">
                        <div class="card-header">
                            <h3>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="15" x2="21" y2="15"/><polyline points="8 9 12 5 16 9"/></svg>
                                ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="max-width:300px;">
                                <canvas id="detailPieChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Layer Counts Table -->
                <div class="lg:col-span-8">
                    <div class="card">
                        <div class="card-header">
                            <h3>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/><path d="M3 12A9 3 0 0 0 21 12"/></svg>
                                ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </h3>
                        </div>
                        <div class="card-body p-0">
                            <table class="data-table" id="layerCountTable">
                                <thead>
                                    <tr>
                                        <th>‡∏ä‡∏±‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</th>
                                        <th>‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</th>
                                        <th class="text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                        <th class="text-right">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô %</th>
                                    </tr>
                                </thead>
                                <tbody id="layerCountBody">
                                    <!-- Filled by JS -->
                                </tbody>
                                <tfoot>
                                    <tr class="total-row">
                                        <td colspan="2"><strong>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</strong></td>
                                        <td class="num" id="layerTotal">0</td>
                                        <td class="num">100%</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Export Section -->
            <div class="card">
                <div class="card-header">
                    <h3>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </h3>
                </div>
                <div class="card-body">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Export Summary Table -->
                        <div class="p-4 rounded-lg" style="background: var(--surface-2); border: 1px solid var(--border);">
                            <h4 class="text-sm font-semibold mb-3 flex items-center gap-2" style="color: var(--pwa-gold);">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/></svg>
                                Export ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ (.xlsx)
                            </h4>
                            <p class="text-xs mb-4" style="color: var(--text-muted);">
                                ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Excel
                            </p>
                            <button class="btn btn-gold" onclick="exportDetailExcel()">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                Download Excel
                            </button>
                        </div>

                        <!-- Export GeoData -->
                        <div class="p-4 rounded-lg" style="background: var(--surface-2); border: 1px solid var(--border);">
                            <h4 class="text-sm font-semibold mb-3 flex items-center gap-2" style="color: var(--accent-cyan);">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                                Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
                            </h4>
                            <p class="text-xs mb-3" style="color: var(--text-muted);">
                                ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• GeoJSON ‡∏û‡∏£‡πâ‡∏≠‡∏° properties ‡∏ó‡∏∏‡∏Å column ‡∏ï‡∏≤‡∏° filter
                            </p>
                            <div class="flex items-center gap-3 mb-4">
                                <label class="filter-label">‡∏ä‡∏±‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label>
                                <select id="exportLayer" class="flex-1">
                                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</option>
                                </select>
                            </div>
                            <div class="flex items-center gap-3 mb-4">
                                <label class="filter-label">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö</label>
                                <select id="exportFormat">
                                    <option value="geojson">GeoJSON (.geojson)</option>
                                    <option value="gpkg">GeoPackage (.gpkg)</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="exportGeoData()">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                Download GeoData
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Initial State (no data yet) -->
        <div id="emptyState" class="text-center py-20">
            <div class="inline-flex items-center justify-center w-20 h-20 rounded-2xl mb-6" style="background: var(--surface-2);">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color: var(--text-muted);">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>
                </svg>
            </div>
            <h3 class="text-lg font-semibold mb-2" style="color: var(--text-secondary);">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
            <p class="text-sm" style="color: var(--text-muted);">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏ô‡∏ß‡∏ô features</p>
        </div>

    </main>

    <footer class="max-w-screen-2xl mx-auto px-4 py-6 text-center relative z-10">
        <p class="text-xs" style="color: var(--text-muted);">
            PWA GIS Online Tracking Dashboard ¬© 2025 ‚Äî Provincial Waterworks Authority
        </p>
    </footer>

    <!-- Flatpickr -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/th.js"></script>

    <script src="/static/js/thai_custom_date.js"></script>
    <script src="/static/js/detail.js"></script>
</body>
</html>